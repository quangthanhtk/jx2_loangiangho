Include("\\script\\vng\\lib\\vnglib_award.lua");
szNpcName = "<color=green>Häc trß thî rÌn L­u: <color>"
DOIPHE_UYHO_TUONGQUAN_FILE = "\\script\\vng\\weapon_upgrade\\doiphetrangbi_uyhotuongquan.lua"; --®æi phe trang bÞ uy hæ t­íng qu©n
DOIPHE_VUKHI_UYHO_TUONGQUAN_FILE = "\\script\\vng\\weapon_upgrade\\doiphetrangbivukhi_uyhotuongquan.lua";
tbUyHo_DoiPhe = { --Uy Hæ T­íng
	[0] = {
		[100] = {
			[32171] = {1,32215},	-- {Material, nP}, tèng ==> liªu
			[32172] = {1,32216},
			[32173] = {1,32217},
			[32174] = {1,32218},
			[32175] = {1,32219},
			[32176] = {1,32220},
			[32177] = {1,32221},
			[32178] = {1,32222},
			[32179] = {1,32223},
			[32180] = {1,32224},
			[32181] = {1,32225},
			[32182] = {1,32226},
			[32183] = {1,32227},
			[32184] = {1,32228},
			[32185] = {1,32229},
			[32186] = {1,32230},
			[32187] = {1,32231},
			[32188] = {1,32232},
			[32189] = {1,32233},
			[32190] = {1,32234},
			[32191] = {1,32235},
			[32192] = {1,32236},
			[32215] = {1,32171},	-- liªu ==> tèng
			[32216] = {1,32172},
			[32217] = {1,32173},
			[32218] = {1,32174},
			[32219] = {1,32175},
			[32220] = {1,32176},
			[32221] = {1,32177},
			[32222] = {1,32178},
			[32223] = {1,32179},
			[32224] = {1,32180},
			[32225] = {1,32181},
			[32226] = {1,32182},
			[32227] = {1,32183},
			[32228] = {1,32184},
			[32229] = {1,32185},
			[32230] = {1,32186},
			[32231] = {1,32187},
			[32232] = {1,32188},
			[32233] = {1,32189},
			[32234] = {1,32190},
			[32235] = {1,32191},
			[32236] = {1,32192},
		},
		[101] = {
			[32171] = {1,32215},	-- {Material, nP}, tèng ==> liªu
			[32172] = {1,32216},
			[32173] = {1,32217},
			[32174] = {1,32218},
			[32175] = {1,32219},
			[32176] = {1,32220},
			[32177] = {1,32221},
			[32178] = {1,32222},
			[32179] = {1,32223},
			[32180] = {1,32224},
			[32181] = {1,32225},
			[32182] = {1,32226},
			[32183] = {1,32227},
			[32184] = {1,32228},
			[32185] = {1,32229},
			[32186] = {1,32230},
			[32187] = {1,32231},
			[32188] = {1,32232},
			[32189] = {1,32233},
			[32190] = {1,32234},
			[32191] = {1,32235},
			[32192] = {1,32236},
			[32215] = {1,32171},	-- liªu ==> tèng
			[32216] = {1,32172},
			[32217] = {1,32173},
			[32218] = {1,32174},
			[32219] = {1,32175},
			[32220] = {1,32176},
			[32221] = {1,32177},
			[32222] = {1,32178},
			[32223] = {1,32179},
			[32224] = {1,32180},
			[32225] = {1,32181},
			[32226] = {1,32182},
			[32227] = {1,32183},
			[32228] = {1,32184},
			[32229] = {1,32185},
			[32230] = {1,32186},
			[32231] = {1,32187},
			[32232] = {1,32188},
			[32233] = {1,32189},
			[32234] = {1,32190},
			[32235] = {1,32191},
			[32236] = {1,32192},
		},
		[103] = {
			[32171] = {1,32215},	-- {Material, nP}, tèng ==> liªu
			[32172] = {1,32216},
			[32173] = {1,32217},
			[32174] = {1,32218},
			[32175] = {1,32219},
			[32176] = {1,32220},
			[32177] = {1,32221},
			[32178] = {1,32222},
			[32179] = {1,32223},
			[32180] = {1,32224},
			[32181] = {1,32225},
			[32182] = {1,32226},
			[32183] = {1,32227},
			[32184] = {1,32228},
			[32185] = {1,32229},
			[32186] = {1,32230},
			[32187] = {1,32231},
			[32188] = {1,32232},
			[32189] = {1,32233},
			[32190] = {1,32234},
			[32191] = {1,32235},
			[32192] = {1,32236},
			[32215] = {1,32171},	-- liªu ==> tèng
			[32216] = {1,32172},
			[32217] = {1,32173},
			[32218] = {1,32174},
			[32219] = {1,32175},
			[32220] = {1,32176},
			[32221] = {1,32177},
			[32222] = {1,32178},
			[32223] = {1,32179},
			[32224] = {1,32180},
			[32225] = {1,32181},
			[32226] = {1,32182},
			[32227] = {1,32183},
			[32228] = {1,32184},
			[32229] = {1,32185},
			[32230] = {1,32186},
			[32231] = {1,32187},
			[32232] = {1,32188},
			[32233] = {1,32189},
			[32234] = {1,32190},
			[32235] = {1,32191},
			[32236] = {1,32192},
		},
		[102] = {
			[31542] = {2,31696},
			[31543] = {2,31697},
			[31544] = {2,31698},
			[31545] = {2,31699},
			[31546] = {2,31700},
			[31547] = {2,31701},
			[31548] = {2,31702},
			[31549] = {2,31703},
			[31550] = {2,31704},            
			[31551] = {2,31705},
			[31552] = {2,31706},
			[31553] = {2,31707},
			[31554] = {2,31708},
			[31555] = {2,31709},
			[31556] = {2,31710},
			[31557] = {2,31711},
			[31558] = {2,31712},
			[31559] = {2,31713},
			[31560] = {2,31714},
			[31561] = {2,31715},
			[31562] = {2,31716},
			[31563] = {2,31717},
			[31564] = {2,31718},
			[31565] = {2,31719},
			[31566] = {2,31720},
			[31567] = {2,31721},
			[31568] = {2,31722},
			[31569] = {2,31723},
			[31570] = {2,31724},
			[31571] = {2,31725},
			[31572] = {2,31726},
			[31573] = {2,31727},
			[31574] = {2,31728},
			[31575] = {2,31729},
			[31576] = {2,31730},
			[31577] = {2,31731},
			[31578] = {2,31732},
			[31579] = {2,31733},
			[31580] = {2,31734},
			[31581] = {2,31735},
			[31582] = {2,31736},
			[31583] = {2,31737},
			[31584] = {2,31738},
			[31585] = {2,31739},
			[31586] = {2,31740},
			[31587] = {2,31741},
			[31588] = {2,31742},
			[31589] = {2,31743},
			[31590] = {2,31744},
			[31591] = {2,31745},
			[31592] = {2,31746},
			[31593] = {2,31747},
			[31594] = {2,31748},
			[31595] = {2,31749},
			[31596] = {2,31750},
			[31597] = {2,31751},
			[31598] = {2,31752},
			[31599] = {2,31753},
			[31600] = {2,31754},
			[31601] = {2,31755},
			[31602] = {2,31756},
			[31603] = {2,31757},
			[31604] = {2,31758},
			[31605] = {2,31759},
			[31606] = {2,31760},
			[31607] = {2,31761},

			[31696] = {2,31542},
			[31697] = {2,31543},
			[31698] = {2,31544},
			[31699] = {2,31545},
			[31700] = {2,31546},
			[31701] = {2,31547},
			[31702] = {2,31548},
			[31703] = {2,31549},
			[31704] = {2,31550},            
			[31705] = {2,31551},
			[31706] = {2,31552},
			[31707] = {2,31553},
			[31708] = {2,31554},
			[31709] = {2,31555},
			[31710] = {2,31556},
			[31711] = {2,31557},
			[31712] = {2,31558},
			[31713] = {2,31559},
			[31714] = {2,31560},
			[31715] = {2,31561},
			[31716] = {2,31562},
			[31717] = {2,31563},
			[31718] = {2,31564},
			[31719] = {2,31565},
			[31720] = {2,31566},
			[31721] = {2,31567},
			[31722] = {2,31568},
			[31723] = {2,31569},
			[31724] = {2,31570},
			[31725] = {2,31571},
			[31726] = {2,31572},
			[31727] = {2,31573},
			[31728] = {2,31574},
			[31729] = {2,31575},
			[31730] = {2,31576},
			[31731] = {2,31577},
			[31732] = {2,31578},
			[31733] = {2,31579},
			[31734] = {2,31580},
			[31735] = {2,31581},
			[31736] = {2,31582},
			[31737] = {2,31583},
			[31738] = {2,31584},
			[31739] = {2,31585},
			[31740] = {2,31586},
			[31741] = {2,31587},
			[31742] = {2,31588},
			[31743] = {2,31589},
			[31744] = {2,31590},
			[31745] = {2,31591},
			[31746] = {2,31592},
			[31747] = {2,31593},
			[31748] = {2,31594},
			[31749] = {2,31595},
			[31750] = {2,31596},
			[31751] = {2,31597},
			[31752] = {2,31598},
			[31753] = {2,31599},
			[31754] = {2,31600},
			[31755] = {2,31601},
			[31756] = {2,31602},
			[31757] = {2,31603},
			[31758] = {2,31604},
			[31759] = {2,31605},
			[31760] = {2,31606},
			[31761] = {2,31607},

			
		},
	},
}
function DoiPhe_UyHoTuongQuan_Menu()
	local strtab = {

		}

	tinsert(strtab,"ChuyÓn ®æi trang bÞ Nãn, ¸o, QuÇn Uy Hæ T­íng Qu©n/#DoiPhe_UyHoTuongQuan(1)")
	tinsert(strtab,"ChuyÓn ®æi trang bÞ Kú, HiÖu, Phï Uy Hæ T­íng Qu©n/#DoiPhe_UyHoTuongQuan(2)")
	tinsert(strtab,"ChuyÓn ®æi trang bÞ Vò KhÝ Uy Hæ T­íng Qu©n/DoiPhe_VuKhi_UyHoTuongQuan")
	
	tinsert(strtab,"Ta chØ ®Õn th¨m «ng th«i!/nothing")
	Say("<color=green>§Ö tö thî rÌn L­u<color>: Ta cã thÓ gióp ®¹i hiÖp chuyÓn ®æi trang bÞ Uy Hæ T­íng tõ phe Tèng sang Liªu hoÆc tõ phe Liªu sang Tèng. <color=red>L­u ý, ®¹i hiÖp sÏ ph¶i ®ôc lç vµ kh¶m §¸ Quý l¹i tõ ®©u.<color>",
		getn(strtab),
		strtab);
end
function DoiPhe_VuKhi_UyHoTuongQuan()
	local nNguyenLieu = {--Thiªn M«n Kim LÖnh, Thiªn Cang LÖnh
								[1] = {{2,1,30370,10}, {2,95,204,10}}, 
							}
	local nCount1 = GetItemCount(2,1,30370)
	local nCount2 = GetItemCount(2,95,204)						
	if nCount1 < nNguyenLieu[1][1][4] then
		Talk(1, "", szNpcName .. "B¹n kh«ng cã ®ñ "..nNguyenLieu[1][1][4].." Thiªn M«n Kim LÖnh ®Ó chuyÓn ®æi trang bÞ Uy Hæ.")
		return 0
	end						
	if nCount2 < nNguyenLieu[1][2][4] then
		Talk(1, "", szNpcName .. "B¹n kh«ng cã ®ñ "..nNguyenLieu[1][2][4].." Thiªn Cang LÖnh ®Ó chuyÓn ®æi trang bÞ Uy Hæ.")
		return 0
	end					
--	if nCount3 < nNguyenLieu[1][3][4] then
--		Talk(1, "", szNpcName .. "B¹n kh«ng cã ®ñ Cöu Thiªn V« Cùc §¬n ®Ó chuyÓn ®æi trang bÞ Uy Hæ.")
--		return 0
--	end		
	PutinItemBox("N©ng cÊp trang bÞ" ,1 , "X¸c nhËn muèn thùc hiÖn n©ng cÊp?", DOIPHE_VUKHI_UYHO_TUONGQUAN_FILE, 1)
end
function DoiPhe_UyHoTuongQuan(nType)
	local nNguyenLieu = {--Thiªn M«n Kim LÖnh, Thiªn Cang LÖnh
								[1] = {{2,1,30370,10}, {2,95,204,10}}, 
								[2] = {{2,1,30370,15}, {2,95,204,15}}, 
							}
	local nCount1 = GetItemCount(2,1,30370)
	local nCount2 = GetItemCount(2,95,204)						
	if nCount1 < nNguyenLieu[nType][1][4] then
		Talk(1, "", szNpcName .. "B¹n kh«ng cã ®ñ "..nNguyenLieu[nType][1][4].." Thiªn M«n Kim LÖnh ®Ó chuyÓn ®æi trang bÞ Uy Hæ.")
		return 0
	end						
	if nCount2 < nNguyenLieu[nType][2][4] then
		Talk(1, "", szNpcName .. "B¹n kh«ng cã ®ñ "..nNguyenLieu[nType][2][4].." Thiªn Cang LÖnh ®Ó chuyÓn ®æi trang bÞ Uy Hæ.")
		return 0
	end					
	
	PutinItemBox("N©ng cÊp trang bÞ" ,1 , "X¸c nhËn muèn thùc hiÖn n©ng cÊp?", DOIPHE_UYHO_TUONGQUAN_FILE, 1)
end

function OnPutinCheck(param, idx, genre, detail, particular)
	if tbUyHo_DoiPhe[genre] == nil then
		Talk(1,"",szNpcName .. "Ta chØ nhËn ®æi trang bÞ Uy Hæ T­íng Qu©n.")
		return 0
	end
	if tbUyHo_DoiPhe[genre][detail] == nil then
		Talk(1,"",szNpcName .. "Ta chØ nhËn ®æi trang bÞ Uy Hæ T­íng Qu©n.")
		return 0
	end
	if tbUyHo_DoiPhe[genre][detail][particular] == nil then
		Talk(1,"",szNpcName .. "Ta chØ nhËn ®æi trang bÞ Uy Hæ T­íng Qu©n.")
		return 0
	end	
--	if detail ~= 102 then
--		if GetEquipAttr(idx,2) < 7 then
--			Talk(1,"",szNpcName .. "Trang bÞ ph¶i ®­îc c­êng hãa 7 trë lªn.")
--			return 0
--		end
--	end
	return 1
end

function OnPutinComplete(param)
	if gf_JudgeRoomWeight(1,100) == 0 then
		Talk(1,"",szNpcName.."Hµnh trang hoÆc søc lùc kh«ng ®ñ, ng­¬i h·y s¾p xÕp l¹i nhÐ!");
		return 0
	end
	local tbUpgradeList = GetPutinItem();
	local nG, nD, nP = tbUpgradeList[1][2], tbUpgradeList[1][3], tbUpgradeList[1][4]
	if tbUyHo_DoiPhe[nG][nD][nP] == nil then
		return 0
	end
	
	-------------------- Check material ----------------------------
	local tbMaterial = {
		[1] = {item={{gdp={2,1,30370,10}}, {gdp={2,95,204,10}}}},	--, task={{707, 30000, "TÝch lòy chiÕn tr­êng"}}
		[2] = {item={{gdp={2,1,30370,15}}, {gdp={2,95,204,15}}}},	
	}
	local nIndex = tbUyHo_DoiPhe[nG][nD][nP][1]
	--=====================
	local nTMKL = 10
	local nTCL = 10
	if nIndex == 2 then
		nTMKL = 15
		nTCL = 15
	end
	local nCount1 = GetItemCount(2,1,30370)
	local nCount2 = GetItemCount(2,95,204)
	
	if nCount1 < nTMKL then
		Talk(1, "", szNpcName .. "B¹n kh«ng cã ®ñ "..nTMKL.." Thiªn M«n Kim LÖnh ®Ó chuyÓn ®æi trang bÞ Uy Hæ.")
		return 0
	end						
	if nCount2 < nTCL then
		Talk(1, "", szNpcName .. "B¹n kh«ng cã ®ñ "..nTCL.."Thiªn Cang LÖnh ®Ó chuyÓn ®æi trang bÞ Uy Hæ.")
		return 0
	end			
	--=======================
	local nCheck = LIB_Award:CheckMaterial(tbMaterial[nIndex])
	if nCheck == 0 then
		return 0
	end
	
	local nLevel = 0
--	if GetEquipAttr(tbUpgradeList[1][1],2) >= 7  and GetEquipAttr(tbUpgradeList[1][1],2) < 10 then
--		nLevel = 7;	
--	end
	
--	if GetEquipAttr(tbUpgradeList[1][1],2) >= 10 then
--		nLevel = 10;	
--	end
	if DelItem(2,1,30370,nTMKL) == 1 and DelItem(2,95,204,nTCL) == 1 then
		local szItemName = GetItemName(nG,nD,tbUyHo_DoiPhe[nG][nD][nP][2])
		LIB_Award.szLogTitle = "CHUYEN DOI PHE TRANG BI UY HO TUONG QUAN"
		LIB_Award.szLogAction = "thµnh c«ng"
		local tbNewItem = {item={{gdp={nG, nD, tbUyHo_DoiPhe[nG][nD][nP][2], 1,1, -1, -1, -1, -1, -1, -1, -1, nLevel}}}}
	--	LIB_Award:PayMaterial(tbMaterial[nIndex])
		DelItemByIndex(tbUpgradeList[1][1],-1)
		LIB_Award:Award(tbNewItem)
		Talk(1,"",szNpcName.."N©ng cÊp thµnh c«ng, h·y nhËn lÊy <color=yellow>" .. szItemName .. "<color> cña ng­¬i.")
		return 1
	end
end
