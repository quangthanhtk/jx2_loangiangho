Include("\\script\\isolate\\functions\\tong_extension\\main.lua")

--***********************************±äÁ¿¶¨ÒåÇø*****************************
--------------------------------------------°ï»áÈÎÎñËæ»úBOSSÊ¹ÓÃ¶¨Òå
Zgc_conf_task_boss = {			--µÚÒ»µÈ¼¶BOSS
	"C«n L«n N«",
	"Bïi Hµng",
	"LiÔu NghÞ",
	"Hång TuyÕn",
	"H¹ C¶nh Th¾ng",
	"NhiÕp §¹i Chïy",
	"Bé Phi Yªn",
}

Zgc_conf_task_box = {
	"R­¬ng cña C«n L«n N« ®Ó l¹i",
	"R­¬ng cña Bïi Hµng ®Ó l¹i",
	"R­¬ng cña LiÔu NghÞ ®Ó l¹i",
	"R­¬ng cña Hång TuyÕn ®Ó l¹i",
	"R­¬ng s¾t cña H¹ C¶nh Th¾ng",
	"R­¬ng s¾t cña NhiÕp §¹i Chïy",
	"B¶o r­¬ng cña Bé Phi Yªn",
}
Zgc_cong_task_usemapid = {
	{302,"Thanh Thµnh s¬n"},		
	{327,"¤ M«ng Bé"},
	{401,"§iÓm Th­¬ng s¬n"},
	{306,"Giang T©n Th«n"},
	{307,"Phong §«"},
	{405,"Ch©n nói Vò L¨ng"},
	{406,"Vò L¨ng s¬n"},
	{326,"Mé TuyÕt s¬n trang"},
	{310,"KiÕm M«n quan"},
	{311,"Phôc Ng­u s¬n"},
	{218,"Linh B¶o s¬n"},
	{202,"H¹nh Hoa th«n"},
	{151,"V©n Méng Tr¹ch"},			
	{601,"§¹i Th¶o Nguyªn 1"},
	{602,"§¹i Th¶o Nguyªn 2"},
	{103,"§«ng H¶i H¶i T©n 1"},
	{104,"§«ng H¶i H¶i T©n 2"},
	{102,"§µo Hoa ®¶o"},
	{207,"NhÞ Long s¬n"},
	{217,"D· Tr­ l©m"},
	{208,"L­¬ng S¬n B¹c"},
	{604,"Nh¹n M«n quan"},
	{106,"Long TuyÒn Th«n"},
	{107,"Vò Di s¬n"},
	{600,"Bé l¹c V­¬ng Kú"},
}

Zgc_award_lv1 = {
	{"VÐ §æi Trang Søc Ngo¹i Trang",{2,1,31320,5,1},0,-1,1000,},
    {"R­¬ng Manh Manh",{2,1,31323,1,1},0,2592000,1000,},
    {"L­u Kim",{2,1,31096,1,1},0,-1,500,},
    {"Thiªn V¨n Th¹ch",{2,201,13,1,1},0,-1,100,},
    {"§ång TÕ Chi NguyÖn",{2,1,30913,1,1},0,-1,1000,},
    {"PhiÕu §æi Ngo¹i Trang",{2,1,31233,1,1},0,-1,1000,},
    {"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,1,1},0,-1,3100,},
    {"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,2,1},0,-1,1000,},
    {"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,5,1},0,-1,500,},
    {"Thiªn Cang LÖnh",{2,95,204,1,1},1,-1,10,},
    {"Thiªn M«n Kim LÖnh",{2,1,30370,1,1},1,-1,10,},
    {"C©y B¸t Nh·",{2,0,398,1,1},0,-1,780,},
}

Zgc_award_lv2 = {
	{"VÐ §æi Trang Søc Ngo¹i Trang",{2,1,31320,1,1},0,-1,500,},
	{"R­¬ng Manh Manh",{2,1,31323,1,1},0,2592000,1000,},
	{"L­u Kim",{2,1,31096,1,1},0,-1,1000,},
	{"Thiªn V¨n Th¹ch",{2,201,13,1,1},0,-1,500,},
	{"§ång TÕ Chi NguyÖn",{2,1,30913,1,1},0,-1,500,},
	{"PhiÕu §æi Ngo¹i Trang",{2,1,31233,1,1},0,-1,500,},
	{"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,1,1},0,-1,2800,},
	{"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,2,1},0,-1,2000,},
	{"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,5,1},0,-1,500,},
	{"Thiªn Cang LÖnh",{2,95,204,1,1},1,-1,5,},
	{"Thiªn M«n Kim LÖnh",{2,1,30370,1,1},1,-1,5,},
	{"C©y B¸t Nh·",{2,0,398,1,1},0,-1,690,},
}

Zgc_award_lv3 = {
	{"VÐ §æi Trang Søc Ngo¹i Trang",{2,1,31320,1,1},0,-1,500,},
	{"R­¬ng Manh Manh",{2,1,31323,1,1},0,2592000,1000,},
	{"L­u Kim",{2,1,31096,1,1},0,-1,1000,},
	{"Thiªn V¨n Th¹ch",{2,201,13,1,1},0,-1,500,},
	{"§ång TÕ Chi NguyÖn",{2,1,30913,1,1},0,-1,500,},
	{"PhiÕu §æi Ngo¹i Trang",{2,1,31233,1,1},0,-1,500,},
	{"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,1,1},0,-1,3500,},
	{"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,2,1},0,-1,1000,},
	{"Tói ChÝ D­¬ng Hoµn (Nhá)",{2,1,31322,5,1},0,-1,500,},
	{"C©y B¸t Nh·",{2,0,398,1,1},0,-1,1000,},
}

function Zgc_getmaxrate(tAward)
    local ret = 0
    for i=1, getn(tAward) do
        ret = ret + tAward[i][5]
    end
    return ret
end

Zgc_conf_task_boss_award = {
	{Zgc_award_lv3, 2, Zgc_getmaxrate(Zgc_award_lv3), 1000},
	{Zgc_award_lv3, 2, Zgc_getmaxrate(Zgc_award_lv3), 1000},
	{Zgc_award_lv3, 2, Zgc_getmaxrate(Zgc_award_lv3), 1000},
	{Zgc_award_lv3, 2, Zgc_getmaxrate(Zgc_award_lv3), 1000},
	{Zgc_award_lv2, 5, Zgc_getmaxrate(Zgc_award_lv2), 2000},
	{Zgc_award_lv2, 5, Zgc_getmaxrate(Zgc_award_lv2), 2000},
	{Zgc_award_lv1, 10, Zgc_getmaxrate(Zgc_award_lv1),4000},
}
--======================================Ê¹ÓÃÉú³½¸ÙÕÙ»½BOSS==============================
function OnUse(id)
	SetItemUseLapse(id,90)
	local mapID,X,Y = GetWorldPos()
	local chk_flag = 0
	for i = 1, getn(Zgc_cong_task_usemapid) do				--Ê¹ÓÃµØÍ¼ÅÐ¶Ï
		if Zgc_cong_task_usemapid[i][1] == mapID then
			chk_flag = 1
			break
		end
	end
	if chk_flag == 0 then
		Say("N¬i ®©y quan binh canh gi÷ nghiªm ngÆt, ®¸m ng­êi Bé Phi Yªn to gan c¸ch mÊy còng kh«ng d¸m bÐn m·ng tíi, ng­¬i thö ®Õn chç kh¸c xem!",
			2,
			"Ta muèn biÕt hµnh tung cña Bé Phi Yªn/Zgc_bfy_actmap_inq",
			"Ta biÕt råi/Zgc_end_dialog"
		)		
	else														--´´½¨BOSS	
		local del_flag = DelItemByIndex(id,1)
		if del_flag ~= 1 then
			WriteLog("Xãa Sinh ThÇn Cang thÊt b¹i, ID thÊt b¹i:"..del_flag)
		else
			local boss_step = random(1,100)
			local npc_index = 0
			local boss_seq = 0
			if boss_step == 37 then
				npc_index = CreateNpc(Zgc_conf_task_boss[7],Zgc_conf_task_boss[7],mapID,X,Y,-1,1,0,0)
				AddRuntimeStat(87, 7, 0, 1)
				SendTongMessage(GetName().."Sö dông Sinh ThÇn Cang gäi ra Bé Phi Yªn!")
				AddGlobalNews(GetTongName().."Cã tin bän hä ®ang giao ®Êu víi Bé Phi Yªn!")
			elseif boss_step <= 33 then
				boss_seq = random(5,6)
				AddRuntimeStat(87, boss_seq, 0, 1)
				npc_index = CreateNpc(Zgc_conf_task_boss[boss_seq],Zgc_conf_task_boss[boss_seq],mapID,X,Y,-1,1,0,0)
				SendTongMessage(GetName().."Sö dông Sinh ThÇn Cang gäi ra:"..Zgc_conf_task_boss[boss_seq].."!")
			else
				boss_seq = random(1,4)
				AddRuntimeStat(87, boss_seq, 0, 1)
				npc_index = CreateNpc(Zgc_conf_task_boss[boss_seq],Zgc_conf_task_boss[boss_seq],mapID,X,Y,-1,1,0,0)
				SendTongMessage(GetName().."Sö dông Sinh ThÇn Cang gäi ra:"..Zgc_conf_task_boss[boss_seq].."!")
			end
			SetNpcScript(npc_index,"\\script\\item\\conftaskbosscreate.lua")
			WriteLog("NhiÖm v?B?Phi Yªn: Ng­êi ch¬i ["..GetName().."] sö dông Sinh ThÇn C­¬ng gäi ra "..Zgc_conf_task_boss[boss_seq])
		end
	end
end
--********************************Éú³½¸Ù¿ÉÊ¹ÓÃµØÍ¼²éÑ¯*****************************
function Zgc_bfy_actmap_inq()
	local dialog_string = "  "
	for i = 1, getn(Zgc_cong_task_usemapid) do
		dialog_string = dialog_string .. Zgc_cong_task_usemapid[i][2]
		if floor(i/4)-(i/4) == 0 then
			dialog_string = dialog_string .."\n  "
		else
			for j = 1,(19-strlen(Zgc_cong_task_usemapid[i][2])) do
				dialog_string = dialog_string .." "
			end
		end
	end
	Say("Bé Phi Yªn hµnh tung bÊt ®Þnh, ng­êi biÕt tung tÝch h¾n ta chØ cã: \n"..dialog_string,
		1,
		"Ta biÕt råi/Zgc_end_dialog"
	)
end
--**********************************BOSSËÀÍö´¦Àí***********************************
function Zgc_dropaward(tAward, nTimes, m,x,y, maxrate, bossName)
    for i = 1, nTimes do
        local rand = random(1,maxrate)
        for j = 1, getn(tAward) do  
            if tAward[j][5] >= rand then
                local time = tAward[j][4]
                DropItemWithParam(tAward[j][2][1],tAward[j][2][2],tAward[j][2][3],m,x,y,0,300,tAward[j][2][4], tAward[j][4])
                if tAward[j][3] == 1 then
                    -- µôÂäÊ±·¢¹«¸æ
                    local szMsg = format("%s ®· bÞ ®¸nh b¹i, r¬i ra %s x%d", bossName, tAward[j][1], tAward[j][2][4])
                    AddGlobalNews(szMsg, 1)
                    local nTongId = GetTongID()
                    if nTongId ~= 0 and nTongId ~= nil then
                        SendTongMessage(szMsg)
                    end
                    
                end
                break
            else
                rand = rand - tAward[j][5]
            end
        end
    end
end

function Zgc_kill_announce(szBossName)
    local szMsg = format("Chóc mõng [%s] ®· ®¸nh b¹i %s!",GetName(), szBossName)    
    AddGlobalNews(szMsg, 1)
    Msg2Global(szMsg)
    local nTongId = GetTongID()
    if nTongId ~= 0 and nTongId ~= nil then
        SendTongMessage(szMsg)
    end
end
function OnDeath(index)
	SetNpcLifeTime(index,0)
	local npc_name = GetNpcName(index)
	local npc_level = 0
	local MapID,X,Y	= GetNpcWorldPos(index)
	---------------------------------ÅÐ¶ÏÊÇÄÄ¸öBOSSËÀÍö------------------------------
	for i = 1, 7 do
		if Zgc_conf_task_boss[i] == npc_name then
			AddRuntimeStat(88, i, 0, 1)
			local taward = Zgc_conf_task_boss_award[i][1]
			local ntime = Zgc_conf_task_boss_award[i][2]
			local maxrate = Zgc_conf_task_boss_award[i][3]
			local tongCash = Zgc_conf_task_boss_award[i][4]
			Zgc_kill_announce(npc_name)
			Zgc_dropaward(taward, ntime, MapID,X,Y, maxrate, npc_name)
			TongExt_AddTongCash( tongCash )
			FireEvent("event_mission_affairs", "tongboss", "killboss", index)
		end
	end
end

function Zgc_end_dialog()

end